\section{Einleitung}

Worum gehts? Firewall Geschichte? Theorie und Technisches über iptables (extra Kapitel)
Die Einleitung \cite{iptables}


\subsection{Begriffsdefinitionen}\label{sec.begriffe}

\paragraph{DMZ}
Wenn als Begriff in der Computernetzwerktechnik verstanden, ist die
\emph{demilitarisierte Zone} ein Netzwerk mit durch Firewalls
kontrollierten Zugriffs\-mög\-lich\-keiten auf die darin vorhandenen Server.
Durch diese Isolation der in der DMZ aufgestellten Systeme gegenüber den anderen
Netzwerken, kann der Zugriff auf Dienste wie beispielsweise E-Mail und Webserver
gestattet werden.
Diese Dienste laufen auf Servern innerhalb der DMZ und sind somit auf möglichst
sichere Weise sowohl vom Internet (Extranet) als auch aus dem LAN (Intranet)
erreichbar,
während gleichzeitig das LAN vor unberechtigten Zugriffen von außen geschützt
wird, so dass beispielsweise die Rechner der Mitarbeiter sicher sind.

\paragraph{NAT}
Unter den Begriff \emph{Network Address Translation} fallen alle Verfahren,
welche Adressinformationen in Datenpaketen durch andere ersetzen.
Typischer Einsatzort sind beispielsweise Router, bei denen NAT nötig wird,
wenn ein LAN aus dem Internet nur über eine IP-Adresse sichtbar ist.

\paragraph{DNAT}
\emph{Destination-NAT} verändert die Ziel-Adresse eines Pakets.
Neben der Ziel-IP im IP-Header kann auch der Ziel-Port in einem
TCP- bzw. UDP-Header geändert werden.
Eingesetzt wird das Verfahren um Pakete, welche an der öf\-fent\-lichen Adresse
des Routers eingehen, an einen anderen Rechner im LAN mit privater IP-Adresse
weiterzuleiten.

\paragraph{SNAT}
Möchte man statt der Ziel-Adresse die Quell-Adresse eines Pakets ändern, wird
dies als \emph{Source-NAT} bezeichnet.
Auch hier lässt sich logischerweise IP-Adresse und TCP- bzw. UDP-Port
modifzieren.
Dieses Verfahren wird nun nicht bei den eingehenden, sondern bei den ausgehenden
Paketen angewandt, um die private lokale Adresse durch die öffentliche zu
ersetzen.

\paragraph{Masquerading}
\emph{Masquerading} stellt eine besondere Form des Source-NAT dar, da beim
Eintragen der Regel in die Tabellen des Kernels die einzusetzende IP-Adresse
nicht bekannt sein muss.
Damit lässt sich Maquerading auch verwenden, wenn die öffentliche Adresse nicht
statisch ist, sondern mittels DHCP zugewiesen wird.
Die Masquerade-Regel wird für einen Netzwerkadapter spezifiziert und beim
Ersetzen der Adresse wird jeweils die aktuelle IP-Adresse des Adapters
übernommen.

\paragraph{Connection Tracking}
TODO


\subsection{Versuchsaufbau}

Ziel ist es das Firmen-LAN sowie die zugehörige DMZ durch die
{\tt iptables} Linux-Firewall abzusichern.

\begin{figure}[h!]
  \centering
    \includegraphics[width=0.9\textwidth]{figures/Netzplan.jpg}
  \caption{Netzplan des Versuchsaufbaus.\cite{labor}}
  \label{fig.netzplan}
\end{figure}

Dazu sind im Versuchsaufbau für jeden der in Abbildung 
\ref{fig.netzplan} abgebildeten Rechner
eine virtuelle Maschine bereitgestellt --- dies ermöglicht leichteres
Testen.

Wir haben uns dazu entschieden, das Netzwerk der \emph{Firma A} aufzubauen.
\emph{Firma B} bleibt unangetastet, und ist somit vollständig vorkonfiguriert,
was ebenfalls ein leichteres Testen ermöglicht, da der Web- und Mail-Server von
\emph{Firma B} aus dem "`Internet"' erreichbar ist und somit auch aus dem LAN
der \emph{Firma A} erreichbar sein muss.
Zudem lässt sich so der "`umgekehrte"' Fall testen: der Zugriff von einem
Rechner aus dem LAN von \emph{Firma B} auf die Dienste von
\emph{Firma A}.\cite{labor}


\section{Linux Konfiguration}

Zunächst müssen zwei Debian 6.0 Maschinen,
mit der minimalen Installation, eingerichtet werden.
Diese repräsentieren die Firewallmaschinen {\tt fw1} und {\tt fw2} von
\emph{Firma A} aus Abbildung \ref{fig.netzplan}.
Zum Einrichten und Testen der Firewall-Rechner wurde noch weitere Software
installiert, welche in Kapitel \ref{sec.software} aufgelistet ist.
Die genaue Konfiguration der einzelnen Netzwerkadapter ist in Kapitel
\ref{sec.netzwerk} beschrieben.


\subsection{Software}\label{sec.software}

In der Debian-Installation sind die Befehle {\tt iptables} und {\tt route}
standardmäßig verfügbar.
Mit {\tt iptables} lassen sich IPv4-Pakete filtern und Network Address
Translations durchführen.
Der Befehl {\tt route} dient zum Ändern der IP-Routing-Tabellen des Kernels um
beispielsweise statische Routen für bestimmte Rechner oder Netzwerke
festzulegen.

Folgende zusätzliche Software wurde via {\tt apt-get}, Debians Paketmanager,
installiert:

\begin{itemize}
    \item iptstate --- IPTables State Top.\\
        Zeigt Informationen über die IP Tables state table an (siehe Kap.
        \ref{sec.tests}).
    \item resolvconf --- Nameserver information handler.\\
        Erlaubt es, die DNS-Nameserver in der Datei
        {\tt /etc/network/interfaces}
        per {\tt dns-nameservers 1.2.3.4 5.6.7.8} zu definieren und
        generiert daraus die benötigten Einträge in der {\tt /etc/resolv.conf}
        (siehe Listings \ref{lst:fw1:eth0} \& \ref{lst:fw2:eth1}).
    \item mcedit --- Internal file editor of GNU Midnight Commander.\\
        Text-Editor für die Konsole, welcher neben Aktionen wie Kopieren,
        Ausschneiden und Einfügen auch Syntax-Highlighting für eine Vielzahl von
        Dateitypen bietet. Hierfür muss der GNU Midnight Commander mittels des
        Pakets {\tt mc} installiert werden.
\end{itemize}


\subsection{Netzwerkadapter}\label{sec.netzwerk}

Die Netzweradapter wurden gemäß der in Abbildung \ref{fig.netzplan}
gezeigten IP-Adressen konfiguriert, dies geschieht über die Datei
{\tt /etc/network/interfaces}.

\subsubsection{\fwa}

Der Firewall Rechner {\tt fw1.firma-a.f223} befindet sich zwischen dem Extranet
(10.1.0.0/24) und der DMZ (192.168.40.0/24).
Damit ergibt sich für die beiden Netzwerkadapter folgende Konfiguration:

\paragraph{eth0} Verbindung zur DMZ.

\begin{lstlisting}[label=lst:fw1:eth0,caption={Netzwerkadapter eth0 Konfiguration.}]
allow-hotplug eth0
iface eth0 inet static
    address 192.168.40.250
    netmask 255.255.255.0
    broadcast 192.168.40.255
    dns-nameservers 192.168.40.1
    dns-search firma-a.f223
\end{lstlisting}

\paragraph{eth1} Verbindung zum Extranet bzw. Internet.

\begin{lstlisting}[label=lst:fw1:eth1,caption={Netzwerkadapter eth1 Konfiguration.}]
allow-hotplug eth1
iface eth1 inet static
    address 10.1.0.131
    netmask 255.255.255.0
    broadcast 10.1.0.0
\end{lstlisting}


\subsubsection{\fwb}

Die Konfiguration für den Firewall Rechner {\tt fw2.firma-a.f223}, der zwischen
der DMZ und dem Intranet (192.168.30.0/24) sitzt, sieht wie folgt aus:

\paragraph{eth0} Verbindung zum Intranet.

\begin{lstlisting}[label=lst:fw2:eth0,caption={Netzwerkadapter eth0 Konfiguration.}]
allow-hotplug eth0
iface eth0 inet static
    address 192.168.30.240
    netmask 255.255.255.0
    network 192.168.30.0
    broadcast 192.168.30.255
    dns-search firma-a.f223
\end{lstlisting}

\paragraph{eth1} Verbindung zur DMZ.

\begin{lstlisting}[label=lst:fw2:eth1,caption={Netzwerkadapter eth1 Konfiguration.}]
allow-hotplug eth1
iface eth1 inet static
    address 192.168.40.240
    netmask 255.255.255.0
    network 192.168.40.0
    broadcast 192.168.40.255
    dns-nameservers 192.168.40.1
\end{lstlisting}


\subsection{Nützliches}

\subsubsection{Einfacher Dateitransfer}

Um auf einfache Weise eine Datei von einem Rechner auf einen anderen zu
kopieren, ohne beispielsweise einen Telnet-, FTP- oder SSH-Server aufsetzen zu
müssen, bietet sich das Programm {\tt Netcat} an.
{\tt Netcat} erlaubt es als "`TCP/IP swiss army knife"'\footnote{
\url{http://nc110.sourceforge.net/}
} server- und client-seitig Daten von der Standardein- oder -ausgabe über
Netzwerkverbindungen zu transportieren.\\

\noindent Empfänger:
\begin{verbatim}
fw2 $ netcat -l -p 8080 > firewall-internal.sh
\end{verbatim}

\noindent Sender:
\begin{verbatim}
fw1 $ cat firewall-external.sh | netcat 192.168.40.240 8080
\end{verbatim}


\subsection{Bootskript}

Debian verwendet das von der Linux Standard Base spezifizierte
\emph{Init Script LSB}\footnote{
\url{http://wiki.debian.org/LSBInitScripts}}, welches Unterstützung
für \emph{dependency based boot sequencing}\footnote{
\url{http://wiki.debian.org/LSBInitScripts/DependencyBasedBoot}
} bietet. Das bedeutet, dass
die Programme die beim Aufstarten des Betriebssystems in einer idealen
Reihenfolge angeordnet werden, so dass es auch keine unangenehme Effekte
durch Abhängigkeiten der Programme untereinander entstehen.

Diese Bootskripte werden in {\tt /etc/init.d/} als Konfigurationsdateien
abgelegt und beginnen mit wohldefinierten Kopfzeilen, wie in Listing
\ref{lst:lsb-header} gezeigt.
In diesen Kopfzeilen kann neben einer Beschreibung auch das
Start- / Stopp-Verhalten sowie die Abhängigkeiten konfiguriert werden.

\begin{lstlisting}[label=lst:lsb-header,caption={Init Script LSB: Kopfzeilen.}]
### BEGIN INIT INFO
# Provides:          scriptname
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start daemon at boot time
# Description:       Enable service provided by daemon.
### END INIT INFO
\end{lstlisting}

Die Angaben bei den Schlüsselwörtern {\tt Default-Start} und {\tt Default-Stop}
geben die Runlevel an, bei den das Skript gestartet beziehungsweise gestoppt
wird.
Für Debian Systeme sind die Runlevel laut Tabelle \ref{tab.runlevel} definiert.
\footnote{
\url{http://debiananwenderhandbuch.de/startstop.html}
}

\begin{table}[htb]
    \centering
    \begin{tabular}{|c|l|}
        \hline
        Runlevel & Beschreibung\\
        \hline
        0       & {\tt halt}, hält das System an, ohne es neu zu starten\\
        1       & Single-User Modus, minimal benötigte Dienste (Wartunsgarbeiten)\\
        2 bis 5 & Multiuser Modus, hier wird üblicherweise gearbeitet\\
        6       & {\tt reboot}, startet das System neu\\
        S und s & bringen das System in den Single-User Modus\\
        \hline
    \end{tabular}
   \caption{Runlevel bei Debian.}\label{tab.runlevel}
\end{table}

\noindent Im Normalbetrieb läuft ein Debian System im Runlevel 2.
Die zusätzlichen Multiuser Runlevel geben die Möglichkeit, verschiedene
Konfigurationen von Diensten einzurichten und den gewünschten Runlevel beim
Starten des Betriebssystems per Kernel-Parameter anzugeben.
Die Firewall-Skripte werden in allen Multiuser Modi gestartet und beim
Herunterfahren des Systems sowie im Single-User Modus, in dem keine
Netzwerkschnittstellen aktiv sind, gestoppt.

{\tt Required-Start} und {\tt Required-Stop} definieren die Dienste, die bei
der Aus\-füh\-rung des Skriptes bereits laufen oder noch laufen müssen.
Für die Firewall-Skripte haben wir an dieser Stelle
\verb!$local_fs $remote_fs $syslog $network! gewählt, da so das Netzwerk und
alle Dateisysteme vorhanden sind und auch der Syslog-Daemon eventuell
auftretende Fehler protokollieren kann.

Das Programm {\tt insserv}\footnote{
\emph{Vor} Debian 6.0 wird {\tt update-rc.d} verwendet.
} aktiviert installierte Init-Skripte, in dem es die passenden symbolischen
Links in den Runlevel-Verzeichnissen ({\tt /etc/init.d/rcX.d}) setzt:

\begin{verbatim}
insserv my_init_script
\end{verbatim}

Nach den Kopfzeilen kommt das eigentliche Skript, welches z.B. mittels
{\tt iptables} die Firewall konfiguriert, aber auch beliebige andere Programme
und Dienste können somit gestartet werden.

\begin{lstlisting}[label=lst:lsb-script,caption={Init Script LSB: Eigentliches Skript.}]
case "$1" in
    start)
        # Startup stuff
        echo "Daemon started."
        ;;
    stop)
        # Shutdown this service
        echo "Daemon stopped."
        ;;
    restart)
        # Restart this service
        echo "Daemon restarted."
        ;;
    *)
        # The default case
        echo "Usage $0 {start|stop|restart}"
        ;;
esac
\end{lstlisting}


\section{Anforderungen}

TODO: generell Anforderungen aus Aufgabenstellung

\subsection{\fwa}

TODO: welche Anforderungen sich anhand der generellen Anforderungen für FW1 ergeben

\paragraph{§ 1 Anforderungsname}

\subsection{\fwb}

TODO: welche Anforderungen sich anhand der generellen Anforderungen für FW2 ergeben

